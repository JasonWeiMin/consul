version: '3.4'

x-workdir:
  &workdir-volume
  type: volume
  source: workdir
  target: /workdir
  volume:
    nocopy: true

volumes:
  workdir:

services:
  # This is a dummy container that we use to create volume and keep it
  # accessible while other containers are down.
  workdir: #NOTE THIS IS DEAD
    image: alpine
    volumes:
      - *workdir-volume
    command:
      - sleep
      - "86400"
    network_mode: "none"

  tcpdump-primary:
    build:
      context: .
      dockerfile: Dockerfile-tcpdump

    # we cant do this in circle but its only here to temporarily enable.
    volumes:
      - type: bind
        source: ./${LOG_DIR}
        target: /data
    command: -v -i any -w /data/primary.pcap
    network_mode: container:envoy_consul-primary_1

  tcpdump-secondary:
    build:
      context: .
      dockerfile: Dockerfile-tcpdump

    # we cant do this in circle but its only here to temporarily enable.
    volumes:
      - type: bind
        source: ./${LOG_DIR}
        target: /data
    command: -v -i any -w /data/secondary.pcap
    network_mode: container:envoy_consul-secondary_1
